<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Technological Network — Library of Futures</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="menu-component.css">
		<script src="https://d3js.org/d3.v7.min.js"></script>
		<style>
			body {
				margin: 0;
				font-family: 'Courier New', monospace;
				background: #1a1a1a;
				color: #cccccc;
				overflow: hidden;
			}
			
			/* Page Header */
			.page-header {
				position: fixed;
				top: 40px;
				left: 40px;
				z-index: 50;
			}
			
			.back-link {
				display: flex;
				align-items: center;
				gap: 12px;
				color: #cccccc;
				text-decoration: none;
				font-size: 13px;
				letter-spacing: 1px;
				transition: color 0.3s;
				text-transform: uppercase;
			}
			
			.back-link:hover {
				color: #ffffff;
			}
			
			.back-arrow {
				font-size: 20px;
			}
			
			/* Sidebar */
			.sidebar {
				position: fixed;
				left: 40px;
				top: 120px;
				width: 320px;
				z-index: 50;
			}
			
			.sidebar-label {
				font-size: 11px;
				color: #888888;
				margin: 0 0 16px 0;
				letter-spacing: 2px;
				text-transform: uppercase;
			}
			
			.decade-title {
				font-size: 56px;
				font-weight: bold;
				margin: 0 0 24px 0;
				color: #ffffff;
				letter-spacing: 2px;
				transition: opacity 0.2s ease;
			}

			.sidebar-text {
				font-size: 15px;
				line-height: 1.8;
				color: #aaaaaa;
				margin-bottom: 40px;
				max-width: 280px;
				transition: opacity 0.2s ease;
			}
			
			/* Timeline Bar */
			.timeline-bar {
				display: flex;
				align-items: flex-end;
				gap: 3px;
				height: 60px;
				margin-top: 40px;
			}
			
			.timeline-decade {
				display: flex;
				flex-direction: column;
				align-items: center;
				flex: 1;
			}
			
			.timeline-bar-fill {
				width: 100%;
				background: #333333;
				transition: all 0.3s;
			}
			
			.timeline-bar-fill.active {
				background: #ffffff;
			}
			
			.timeline-label {
				font-size: 9px;
				color: #666666;
				margin-top: 8px;
				letter-spacing: 1px;
			}
			
			/* Navigation Buttons */
			.nav-buttons {
				position: fixed;
				top: 50%;
				right: 40px;
				z-index: 50;
			}
			
			.nav-btn {
				background-color: #2a2a2a;
				border: 1px solid white;
				color: #cccccc;
				padding: 14px 28px;
				font-family: 'Courier New', monospace;
				font-size: 12px;
				letter-spacing: 1.5px;
				cursor: pointer;
				transition: all 0.3s;
				text-decoration: none;
				display: inline-block;
				text-transform: uppercase;
			}
			
			.nav-btn:hover {
				background-color: #3a3a3a;
				border-color: #666666;
				color: #ffffff;
			}
			
			/* Main Container */
			#chordContainer {
				width: 100vw;
				height: 100vh;
				display: flex;
				align-items: center;
				justify-content: center;
				background: #1a1a1a;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
			}
			
			.loading {
				color: #666666;
				font-size: 14px;
				letter-spacing: 2px;
			}
			
			/* Chord Graph Overrides - allow JS to animate colors dynamically while scrolling */
			#chordContainer .link {
				/* default faint link color; JS will override stroke/stroke-width/opacity during setDecade */
				stroke: #3b82f6;
				opacity: 0.4;
				transition: stroke 180ms ease, opacity 180ms ease, stroke-width 180ms ease;
			}

			#chordContainer .link:hover {
				stroke: #60a5fa;
				opacity: 0.9;
			}

			#chordContainer .node circle {
				fill: #2a2a2a; /* keep dark fill */
				/* node outline default (blue) - JS will animate stroke / radius */
				stroke: #3b82f6;
				stroke-width: 2;
				transition: stroke 180ms ease, r 180ms ease, stroke-width 180ms ease;
			}

			#chordContainer .node circle:hover {
				fill: #3a3a3a;
				stroke: #60a5fa;
				stroke-width: 3;
			}
			
			#chordContainer .node-text {
				fill: #cccccc !important;
				font-size: 12px !important;
			}
			
			#chordContainer .node-label-bg {
				fill: #1a1a1a !important;
				opacity: 0.9 !important;
				stroke: #333333 !important;
				stroke-width: 1px !important;
			}
			
			.chord-tooltip {
				background: rgba(26, 26, 26, 0.98) !important;
				border: 1px solid #444444 !important;
				color: #cccccc !important;
			}

			/* Timeline Filter */
			.timeline-container {
				margin-top: 40px;
			}

			.timeline-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 16px;
			}

			.timeline-filter-label {
				font-size: 11px;
				color: #888888;
				letter-spacing: 1.5px;
				text-transform: uppercase;
			}

			.decade-value {
				font-size: 16px;
				font-weight: bold;
				color: #ffffff;
				letter-spacing: 1px;
			}

			.timeline-track {
				position: relative;
				width: 100%;
				height: 6px;
				background: #333333;
				border-radius: 3px;
				cursor: pointer;
			}

			.timeline-handle {
				position: absolute;
				left: 0;
				top: 50%;
				transform: translate(-50%, -50%);
				width: 18px;
				height: 18px;
				background: #ffffff;
				border: 2px solid #444444;
				border-radius: 50%;
				cursor: grab;
				transition: all 0.2s;
			}

			.timeline-handle:hover {
				width: 22px;
				height: 22px;
				border-color: #60a5fa;
			}

			.timeline-handle:active {
				cursor: grabbing;
				background: #60a5fa;
			}
		</style>
	</head>
	<body>
		<!-- Menu Button -->
		<div class="top-nav">
			<button class="menu-button" id="menuButton">MENU</button>
		</div>

		<!-- Menu Overlay -->
		<div class="menu-overlay" id="menuOverlay"></div>

		<!-- Menu Sidebar -->
		<div class="menu-sidebar" id="menuSidebar">
			<div class="menu-header">
				<button class="menu-close" id="menuClose">MENU</button>
			</div>
			<ul class="menu-items">
				<li><a href="aboutPage.html">0. ABOUT</a></li>
				<li><a href="index.html">1. Library</a></li>
				<li><a href="chordGraph.html">2. Technological Network</a></li>
				<li><a href="parallel.html">3. Prediction Timeline</a></li>
				<li><a href="morph.html">4. World Building</a></li>
				<li><a href="#">5. Reflection</a></li>
			</ul>
		</div>

		<!-- Page Header -->
		<div class="page-header">
			<a href="bookshelf.html" class="back-link">
				<span class="back-arrow">←</span>
				<span>Return to Shelf</span>
			</a>
		</div>

		<!-- Sidebar Content -->
		<div class="sidebar">
			<div class="sidebar-label">Motifs</div>
			<h1 class="decade-title" id="decadeTitle">All Decades</h1>
			<p class="sidebar-text" id="sidebarText">
				Drag the timeline below to filter movies by decade and see how technological themes evolve across eras.
			</p>
			
			<!-- Timeline Filter -->
			<div class="timeline-container">
				<div class="timeline-header">
					<span class="timeline-filter-label">Filter by Year Window:</span>
					<span class="decade-value" id="decadeValue">All</span>
				</div>
				<div class="timeline-track" id="timelineTrack">
					<div class="timeline-handle" id="timelineHandle"></div>
				</div>
			</div>
		</div>

		<!-- Navigation Buttons -->
		<div class="nav-buttons">
			<a href="parallel.html" class="nav-btn" id="nextBtn">Next →</a>
		</div>

		<!-- Main Visualization -->
		<div id="chordContainer">
			<div class="loading">Loading visualization...</div>
		</div>

		<script src="./chordGraph.js"></script>
		<script>
			// Menu functionality
			const menuButton = document.getElementById('menuButton');
			const menuClose = document.getElementById('menuClose');
			const menuSidebar = document.getElementById('menuSidebar');
			const menuOverlay = document.getElementById('menuOverlay');

			function openMenu() {
				menuSidebar.classList.add('active');
				menuOverlay.classList.add('active');
			}

			function closeMenu() {
				menuSidebar.classList.remove('active');
				menuOverlay.classList.remove('active');
			}

			menuButton.addEventListener('click', openMenu);
			menuClose.addEventListener('click', closeMenu);
			menuOverlay.addEventListener('click', closeMenu);

			document.addEventListener('keydown', function(event) {
				if (event.key === 'Escape' && menuSidebar.classList.contains('active')) {
					closeMenu();
				}
			});

			// Chord Graph initialization
			(async function() {
				const containerId = 'chordContainer';
				const cg = new ChordGraph(containerId);

				try {
					await cg.loadData('./merged_movies_data.csv');
				} catch (err) {
					document.getElementById(containerId).innerHTML =
						'<div style="padding:20px;color:#888888">Failed to load data: ' +
						(err.message || err) + '</div>';
					return;
				}

				// Get movie from URL parameter or use default
				const params = new URLSearchParams(window.location.search);
				const movieParam = params.get('movie');
				const movieTitles = cg.getMovieTitles();
				const movieToRender = movieParam || movieTitles[0];

				if (movieToRender) {
					try {
						cg.render(movieToRender, {
							width: Math.min(1400, window.innerWidth - 100),
							height: Math.min(1000, window.innerHeight - 100)
						});

						// Center the visualization
						setTimeout(() => {
							try {
								const svgEl = d3.select('#' + containerId + ' svg');
								svgEl.attr('preserveAspectRatio', 'xMidYMid meet')
									.style('display', 'block')
									.style('margin', '0 auto');

								// initialize decade visuals (show All)
								if (cg && typeof cg.setDecade === 'function') cg.setDecade(null);
							} catch(e) {}
						}, 100);
					} catch(e) {
						console.error('Render error:', e);
					}
				}

				// Timeline functionality (5-year windows)
				const minYear = 1950;
				const maxYear = 2020;
				const yearStep = 5; // 5-year windows
				const years = [];
				for (let y = minYear; y <= maxYear; y += yearStep) {
					years.push(y);
				}

				// Decade descriptions
				const decadeContent = {
					null: {
						title: 'All Decades',
						text: 'Drag the timeline below to filter movies by decade and see how technological themes evolve across eras.'
					},
					1950: {
						title: '1950s',
						text: 'The dawn of the atomic age. Cold War anxieties manifest in tales of alien invasions and nuclear mutations. Science fiction emerges as a serious literary genre.'
					},
					1960: {
						title: '1960s',
						text: 'Space race optimism meets counterculture rebellion. From lunar landings to dystopian warnings, the decade explores both the promise and peril of progress.'
					},
					1970: {
						title: '1970s',
						text: 'Post-apocalyptic visions and ecological collapse. Growing environmental consciousness and economic uncertainty reshape sci-fi into darker, more cynical narratives.'
					},
					1980: {
						title: '1980s',
						text: 'Cyberpunk emerges as computers enter homes. Corporate dystopias, virtual realities, and the merger of human and machine define a new technological anxiety.'
					},
					1990: {
						title: '1990s',
						text: 'The internet revolution begins. Virtual worlds, digital consciousness, and questioning reality itself become central themes as the millennium approaches.'
					},
					2000: {
						title: '2000s',
						text: 'Post-9/11 surveillance states and the war on terror. Superhero narratives dominate as society grapples with security, privacy, and global connectivity.'
					},
					2010: {
						title: '2010s',
						text: 'AI awakening and climate crisis. Automation anxiety, social media dystopias, and existential questions about humanity\'s future in an age of machine intelligence.'
					},
					2020: {
						title: '2020s',
						text: 'Pandemic futures and multiverse theory. Reality becomes increasingly fluid as science fiction and present-day concerns blur into one another.'
					}
				};

				function updateDecadeDisplay(startYear, skipAnimation = false) {
					const decadeValue = document.getElementById('decadeValue');
					const decadeTitle = document.getElementById('decadeTitle');
					const sidebarText = document.getElementById('sidebarText');

					let content = null;
					if (!startYear) {
						decadeValue.textContent = 'All';
						content = decadeContent[null];
					} else {
						decadeValue.textContent = `${startYear}-${startYear + yearStep - 1}`;
						// try to reuse the nearest decade description (e.g., 1960s) if available
						const decadeKey = Math.floor(startYear / 10) * 10;
						content = decadeContent[decadeKey] || decadeContent[null];
					}

					if (content) {
						if (skipAnimation) {
							decadeTitle.textContent = content.title;
							sidebarText.textContent = content.text;
						} else {
							decadeTitle.style.opacity = '0';
							sidebarText.style.opacity = '0';
							setTimeout(() => {
								decadeTitle.textContent = content.title;
								sidebarText.textContent = content.text;
								decadeTitle.style.opacity = '1';
								sidebarText.style.opacity = '1';
							}, 100);
						}
					}
				}

				// Initialize with "All" decade display (no animation on first load)
				updateDecadeDisplay(null, true);

				// Make timeline handle draggable (horizontal)
				(function enableTimelineDrag() {
					let dragging = false;
					const track = document.getElementById('timelineTrack');
					const handle = document.getElementById('timelineHandle');

					// Track the last pointer type (mouse / touch / pen). We only enable wheel-based
					// year-scrub when the pointer is a mouse (so trackpad gestures keep default behavior).
					let lastPointerType = null;
					// Throttle wheel stepping to avoid overly sensitive wheels. We'll allow one step
					// per `wheelStepCooldownMs` and require a minimum delta magnitude.
					let lastWheelStep = 0;
					const wheelStepCooldownMs = 140; // milliseconds between allowed wheel steps
					const wheelDeltaThreshold = 6; // minimum delta to count as a step
					const chordEl = document.getElementById('chordContainer');
					track.addEventListener('pointerover', (e) => { lastPointerType = e.pointerType; });
					if (chordEl) chordEl.addEventListener('pointerover', (e) => { lastPointerType = e.pointerType; });

					// Click on track to jump
					track.addEventListener('click', (e) => {
						if (e.target === handle) return;
						const rect = track.getBoundingClientRect();
						const x = e.clientX - rect.left;
						updateTimelineFromX(x, rect.width);
					});

					handle.addEventListener('pointerdown', (e) => {
						dragging = true;
						handle.setPointerCapture(e.pointerId);
						e.preventDefault();
					});

					window.addEventListener('pointerup', () => {
						dragging = false;
					});

					window.addEventListener('pointermove', (e) => {
						if (!dragging) return;
						const rect = track.getBoundingClientRect();
						let x = e.clientX - rect.left;
						updateTimelineFromX(x, rect.width);
					});

					// Allow wheel to scrub left/right over the timeline track or the main viz in discrete steps
					function wheelScrub(e){
						// Only intercept wheel gestures when the pointer was last a mouse.
						// This avoids hijacking trackpad gestures (two-finger scroll) which users expect to scroll the page.
						if (lastPointerType !== 'mouse') return; // let default browser handling occur for non-mouse pointers
						const now = performance.now();
						// compute a sensible delta magnitude (prefer horizontal if present)
						const rawDelta = Math.abs(e.deltaX) > 0 ? e.deltaX : e.deltaY;
						const mag = Math.abs(rawDelta || 0);
						// ignore very small deltas
						if (mag < wheelDeltaThreshold) return;
						// throttle rapid-fire wheel events
						if (now - lastWheelStep < wheelStepCooldownMs) return;
						lastWheelStep = now;

						// For mouse wheel we always use it to cycle through the year windows (no zoom)
						e.preventDefault();
						const rect = track.getBoundingClientRect();
						const totalSteps = years.length + 1; // +1 for All
						let currentPercent = 0;
						if (handle.style.left && handle.style.left.indexOf('%')>-1) currentPercent = parseFloat(handle.style.left)/100;
						else currentPercent = (handle.offsetLeft || 0) / rect.width;
						let currentIndex = Math.round(currentPercent * (totalSteps - 1));
						// Decide direction: positive delta -> move right/forward
						const dir = (rawDelta || 0) > 0 ? 1 : -1;
						let newIndex = Math.max(0, Math.min(totalSteps - 1, currentIndex + dir));
						const newX = (newIndex / (totalSteps - 1)) * rect.width;
						updateTimelineFromX(newX, rect.width);
					}

					track.addEventListener('wheel', wheelScrub, {passive:false});
					if (chordEl) chordEl.addEventListener('wheel', wheelScrub, {passive:false});

					function updateTimelineFromX(x, width) {
						if (x < 0) x = 0;
						if (x > width) x = width;
						const progress = x / width;

						// Map progress to 5-year windows (0 = "All", then 1950, 1955, ...)
						const totalSteps = years.length + 1; // +1 for "All"
						const stepIndex = Math.round(progress * (totalSteps - 1));

						let currentStartYear;
						if (stepIndex === 0) {
							currentStartYear = null; // "All"
						} else {
							currentStartYear = years[stepIndex - 1];
						}

						// Update handle position
						const handleProgress = stepIndex / (totalSteps - 1);
						handle.style.left = (handleProgress * 100) + '%';

						// Update display and filter
						updateDecadeDisplay(currentStartYear);
						cg.setDecade(currentStartYear);
					}
				})();
			})();
		</script>
	</body>
</html>
