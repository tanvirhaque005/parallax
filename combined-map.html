<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Movie Location Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Space Mono', 'Courier New', monospace;
            background: #0a0e27;
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
            background: linear-gradient(180deg, #0f1729 0%, #1a1f3a 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(100, 200, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            color: #b0b8d0;
            margin-bottom: 30px;
            font-size: 0.9em;
            line-height: 1.7;
        }

        .decade-selector {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(26, 31, 58, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .decade-selector-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #ffffff;
        }

        .decade-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .decade-btn {
            padding: 8px 16px;
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            background: rgba(59, 89, 152, 0.3);
            border: 2px solid rgba(100, 200, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: #b0b8d0;
        }

        .decade-btn:hover {
            background: rgba(59, 89, 152, 0.5);
            border-color: rgba(100, 200, 255, 0.5);
        }

        .decade-btn.active {
            background: #3b5998;
            color: white;
            border-color: #64c8ff;
        }

        .decade-btn.all {
            background: rgba(100, 200, 255, 0.2);
            border-color: rgba(100, 200, 255, 0.4);
        }

        .decade-btn.all.active {
            background: #64c8ff;
            color: #0a0e27;
            border-color: #64c8ff;
        }

        .stats {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(26, 31, 58, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #64c8ff;
        }

        .stat-label {
            font-size: 0.75em;
            color: #b0b8d0;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .maps-container {
            position: relative;
            margin-top: 20px;
            min-height: 700px;
        }

        .solar-system-section {
            width: 100%;
            background: rgba(26, 31, 58, 0.4);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .callout-box {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 48%;
            min-width: 600px;
            height: 650px;
            background: linear-gradient(135deg, rgba(15, 23, 41, 0.98) 0%, rgba(26, 31, 58, 0.98) 100%);
            border: 3px solid rgba(100, 200, 255, 0.6);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 40px rgba(100, 200, 255, 0.3);
            z-index: 20;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .callout-box:hover {
            border-color: rgba(100, 200, 255, 0.9);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.9), 0 0 60px rgba(100, 200, 255, 0.5);
            transform: translateY(-2px);
        }

        .callout-box h3 {
            margin: 0 0 12px 0;
            color: #64c8ff;
            font-size: 1.1em;
            text-align: center;
            font-weight: 700;
        }

        .callout-connector {
            position: absolute;
            pointer-events: none;
            z-index: 15;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .map-section {
            background: rgba(26, 31, 58, 0.4);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .map-section h2 {
            text-align: center;
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .map-canvas {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            overflow: visible;
        }

        #earth-map {
            background: #fafbfc;
            width: 100%;
            height: 500px;
            border-radius: 6px;
        }

        #solar-system {
            background: radial-gradient(ellipse at center, #1a1f3a 0%, #0a0e27 100%);
            height: 700px;
        }

        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            padding: 12px;
            background: rgba(26, 31, 58, 0.4);
            border-radius: 6px;
            font-size: 0.75em;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-line {
            width: 25px;
            height: 2px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 350px;
            line-height: 1.6;
            border: 1px solid rgba(100, 200, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        /* Earth map specific styles */
        @keyframes pulse {
            0%, 100% { stroke-opacity: 0.3; }
            50% { stroke-opacity: 0.7; }
        }

        path.connection {
            fill: none;
            stroke-width: 1.5;
            stroke-opacity: 0.3;
            cursor: pointer;
            animation: pulse 3s ease-in-out infinite;
            transition: stroke-width 0.2s, stroke-opacity 0.2s;
        }

        path.connection.earth {
            stroke: #1e3a8a;
        }

        path.connection.space {
            stroke: #64c8ff;
        }

        path.connection.highlighted {
            stroke-width: 3;
            stroke-opacity: 0.9;
            animation: none;
        }

        path.connection.space.highlighted {
            stroke-width: 4;
            filter: drop-shadow(0 0 8px rgba(100, 200, 255, 0.8));
        }

        path.connection.fantasy {
            stroke: #d946ef;
        }

        path.connection.fantasy.highlighted {
            stroke-width: 4;
            filter: drop-shadow(0 0 8px rgba(217, 70, 239, 0.8));
        }

        circle.city {
            fill: #1e3a8a;
            stroke: white;
            stroke-width: 1;
            transition: all 0.3s;
            cursor: pointer;
        }

        circle.city.filming-location {
            fill: #dc2626;
        }

        circle.city:hover {
            fill: #0f172a;
        }

        circle.city.filming-location:hover {
            fill: #991b1b;
        }

        /* Solar system specific styles */
        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 200, 100, 0.8)); }
            50% { filter: drop-shadow(0 0 20px rgba(255, 200, 100, 1)); }
        }

        circle.sun {
            filter: drop-shadow(0 0 30px rgba(255, 200, 100, 0.8));
            animation: glow 4s ease-in-out infinite;
        }

        circle.planet {
            cursor: pointer;
            transition: all 0.3s;
        }

        circle.planet:hover {
            stroke-width: 3;
            filter: drop-shadow(0 0 10px currentColor);
        }

        circle.moon {
            cursor: pointer;
            transition: all 0.3s;
        }

        circle.moon:hover {
            stroke-width: 2;
            filter: drop-shadow(0 0 8px currentColor);
        }

        .orbit-path {
            fill: none;
            stroke: rgba(100, 200, 255, 0.15);
            stroke-width: 1;
            stroke-dasharray: 5, 5;
        }

        text.label {
            font-size: 10px;
            fill: #b0b8d0;
            text-anchor: middle;
            pointer-events: none;
            font-family: 'Space Mono', monospace;
        }

        text.planet-label {
            font-size: 10px;
            fill: #b0b8d0;
            text-anchor: middle;
            pointer-events: none;
            font-family: 'Space Mono', monospace;
        }

        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(26, 31, 58, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }

        .info-section h3 {
            margin-top: 0;
            color: #ffffff;
            font-weight: 700;
            font-size: 1em;
        }

        .info-section p {
            color: #b0b8d0;
            line-height: 1.7;
            font-size: 0.85em;
        }

        @media (max-width: 1200px) {
            .callout-box {
                position: relative;
                width: 100%;
                min-width: unset;
                margin-bottom: 20px;
                left: 0;
                top: 0;
                height: auto;
            }

            .callout-connector {
                display: none;
            }

            #earth-map {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            #earth-map {
                height: 300px;
            }

            .callout-box {
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sci-Fi Movie Location Map</h1>
        <p class="subtitle">
            Exploring filming locations on Earth and journey destinations in space
        </p>

        <div class="decade-selector">
            <div class="decade-selector-title">Filter by Decade:</div>
            <div class="decade-buttons" id="decadeButtons"></div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="earthConnectionCount">0</div>
                <div class="stat-label">Earth Connections</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="earthCityCount">0</div>
                <div class="stat-label">Earth Cities</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="spaceConnectionCount">0</div>
                <div class="stat-label">Space Journeys</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="spaceLocationCount">0</div>
                <div class="stat-label">Space Destinations</div>
            </div>
        </div>

        <div class="maps-container">
            <!-- Callout Box with Earth Detail Map -->
            <div class="callout-box">
                <h3>üåç Earth Detail: Filming ‚Üí Story Locations <span style="font-size: 0.75em; opacity: 0.7;">(Click to expand)</span></h3>
                <div id="earth-map"></div>
                <div class="legend" style="margin-top: 10px; padding: 10px; font-size: 0.8em;">
                    <div class="legend-item">
                        <div class="legend-line" style="background: #1e3a8a; opacity: 0.5; width: 25px;"></div>
                        <span>Connection</span>
                    </div>
                    <div class="legend-item">
                        <svg width="12" height="12">
                            <circle cx="6" cy="6" r="3" fill="#dc2626" stroke="white" stroke-width="1"/>
                        </svg>
                        <span>Filming</span>
                    </div>
                    <div class="legend-item">
                        <svg width="12" height="12">
                            <circle cx="6" cy="6" r="3" fill="#1e3a8a" stroke="white" stroke-width="1"/>
                        </svg>
                        <span>Story</span>
                    </div>
                </div>
            </div>

            <!-- Connector lines SVG -->
            <svg class="callout-connector" id="connector-svg">
                <!-- Will be drawn dynamically -->
            </svg>

            <!-- Solar System Map -->
            <div class="solar-system-section">
                <h2>üåå Solar System: Space & Fantasy Journeys</h2>
                <div id="solar-system" class="map-canvas"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-line" style="background: #64c8ff; opacity: 0.6;"></div>
                        <span>Space Journey</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #d946ef; opacity: 0.6;"></div>
                        <span>Fantasy Journey</span>
                    </div>
                    <div class="legend-item">
                        <svg width="14" height="14">
                            <circle cx="7" cy="7" r="5" fill="#ffa500" stroke="#ffcc66" stroke-width="1"/>
                        </svg>
                        <span>Sun</span>
                    </div>
                    <div class="legend-item">
                        <svg width="14" height="14">
                            <circle cx="7" cy="7" r="4" fill="#4a90e2" stroke="#64c8ff" stroke-width="1"/>
                        </svg>
                        <span>Planet</span>
                    </div>
                    <div class="legend-item">
                        <svg width="14" height="14">
                            <circle cx="7" cy="7" r="4" fill="#d946ef" stroke="#e879f9" stroke-width="1"/>
                        </svg>
                        <span>Fantasy Realm</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h3>About This Visualization</h3>
            <p>
                <strong>Earth Detail Callout:</strong> The highlighted callout box shows a zoomed-in view of Earth,
                displaying where sci-fi movies were filmed (red dots) versus where their stories take place (blue dots).
                Connector lines link this detail view to the Earth planet in the solar system.
            </p>
            <p>
                <strong>Solar System View:</strong> The main visualization shows journey paths in science fiction.
                Blue arcs connect Earth to space destinations including the Moon, Mars, Jupiter, Europa, and deep space.
                Purple/pink arcs connect Earth to fantasy realms like Dream Worlds, Virtual Reality, and Alternate Realities.
                Each connection represents a movie's depicted journey through space or into imagined dimensions.
            </p>
            <p>
                <strong>Interactive Filtering:</strong> Use the decade selector above to filter both visualizations simultaneously
                and explore how sci-fi filmmaking locations and space travel themes evolved across different eras.
                Hover over connections and planets to see detailed movie information.
            </p>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v4.min.js"></script>
    <script>
        let tooltip;
        let selectedDecade = null;

        // Earth connections data
        let earthConnections = [];
        let earthCoordinates = {};

        // Space connections data
        const spaceConnections = [
            {"movie": "2001: A Space Odyssey", "year": "1968", "rating": "8.3", "from": "Earth", "to": "Jupiter"},
            {"movie": "Contact", "year": "1997", "rating": "7.4", "from": "Earth", "to": "Deep Space"},
            {"movie": "Europa Report", "year": "2013", "rating": "6.5", "from": "Earth", "to": "Europa"},
            {"movie": "Moon", "year": "2009", "rating": "8.0", "from": "Earth", "to": "Moon"},
            {"movie": "Mr. Nobody", "year": "2009", "rating": "7.9", "from": "Earth", "to": "Mars"},
            {"movie": "The Martian", "year": "2015", "rating": "8.2", "from": "Earth", "to": "Mars"},
            {"movie": "The Fifth Element", "year": "1997", "rating": "7.6", "from": "Earth", "to": "Deep Space"},
            {"movie": "The Hitchhiker's Guide to the Galaxy", "year": "2005", "rating": "6.8", "from": "Earth", "to": "Deep Space"},
            {"movie": "The Signal", "year": "2014", "rating": "6.2", "from": "Earth", "to": "Deep Space"},
            {"movie": "Doctor Who", "year": "1964", "rating": "8.9", "from": "Earth", "to": "Deep Space"},
            {"movie": "Hitchhiker's Guide to the Galaxy", "year": "1981", "rating": "8.0", "from": "Earth", "to": "Deep Space"},
            {"movie": "Stargate Atlantis", "year": "2004", "rating": "8.1", "from": "Earth", "to": "Deep Space"},
            {"movie": "Stargate SG1", "year": "1997", "rating": "8.5", "from": "Earth", "to": "Deep Space"},
            {"movie": "The 100", "year": "2014", "rating": "7.7", "from": "Earth", "to": "Deep Space"},
            {"movie": "Sunshine", "year": "2007", "rating": "7.3", "from": "Earth", "to": "Sun"},
            {"movie": "Cargo", "year": "2009", "rating": "6.2", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Forbidden Planet", "year": "1956", "rating": "7.6", "from": "Earth", "to": "Deep Space"},
            {"movie": "Screamers", "year": "1995", "rating": "6.3", "from": "Earth", "to": "Deep Space"},
            {"movie": "Serenity (Firefly)", "year": "2005", "rating": "8.0", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Solaris (1972)", "year": "1972", "rating": "8.1", "from": "Earth", "to": "Deep Space"},
            {"movie": "Solaris (2002)", "year": "2002", "rating": "6.2", "from": "Earth", "to": "Deep Space"},
            {"movie": "Star Trek II", "year": "1982", "rating": "7.7", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Babylon 5", "year": "1994", "rating": "8.2", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Battlestar Galactica", "year": "2004", "rating": "8.8", "from": "Deep Space", "to": "Earth"},
            {"movie": "Blakes 7", "year": "1978", "rating": "8.0", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Farscape", "year": "1999", "rating": "8.4", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Firefly", "year": "2002", "rating": "9.2", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Red Dwarf", "year": "1988", "rating": "8.5", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Star Trek: Deep Space Nine", "year": "1993", "rating": "7.9", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Star Trek: Discovery", "year": "2017", "rating": "7.3", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Star Trek: Enterprise", "year": "2001", "rating": "7.5", "from": "Earth", "to": "Deep Space"},
            {"movie": "Star Trek: The Next Generation", "year": "1987", "rating": "8.7", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "Star Trek: The Original Series", "year": "1966", "rating": "8.4", "from": "Earth", "to": "Deep Space"},
            {"movie": "Stargate Universe", "year": "2009", "rating": "7.7", "from": "Deep Space", "to": "Deep Space"},
            {"movie": "The Orville", "year": "2017", "rating": "7.9", "from": "Deep Space", "to": "Deep Space"},

            // Fantasy location connections
            {"movie": "Inception", "year": "2010", "rating": "8.8", "from": "Earth", "to": "Dream Worlds"},
            {"movie": "Paprika", "year": "2006", "rating": "7.7", "from": "Earth", "to": "Dream Worlds"},
            {"movie": "The Matrix", "year": "1999", "rating": "8.7", "from": "Earth", "to": "Virtual Reality"},
            {"movie": "The Thirteenth Floor", "year": "1999", "rating": "7.0", "from": "Earth", "to": "Virtual Reality"},
            {"movie": "Dark City", "year": "1998", "rating": "7.7", "from": "Earth", "to": "Alternate Reality"},
            {"movie": "Metropolis", "year": "1927", "rating": "8.3", "from": "Earth", "to": "Alternate Reality"},
            {"movie": "Brazil", "year": "1985", "rating": "8.0", "from": "Earth", "to": "Alternate Reality"},
            {"movie": "Fringe", "year": "2008", "rating": "8.4", "from": "Earth", "to": "Alternate Reality"},

            // Fictional planets
            {"movie": "Dune", "year": "1984", "rating": "6.6", "from": "Earth", "to": "Arrakis"},
            {"movie": "Dune", "year": "2000", "rating": "7.0", "from": "Earth", "to": "Arrakis"},
            {"movie": "Children of Dune", "year": "2003", "rating": "7.7", "from": "Earth", "to": "Arrakis"}
        ];

        function getDecade(year) {
            const y = parseInt(year);
            if (isNaN(y)) return null;
            return Math.floor(y / 10) * 10;
        }

        function createDecadeButtons() {
            // Get decades from both datasets
            const decades = new Set();

            earthConnections.forEach(conn => {
                const decade = getDecade(conn.year);
                if (decade) decades.add(decade);
            });

            spaceConnections.forEach(conn => {
                const decade = getDecade(conn.year);
                if (decade) decades.add(decade);
            });

            const sortedDecades = Array.from(decades).sort((a, b) => a - b);
            const buttonsContainer = document.getElementById('decadeButtons');
            buttonsContainer.innerHTML = '';

            const allBtn = document.createElement('button');
            allBtn.className = 'decade-btn all active';
            allBtn.textContent = 'All';
            allBtn.onclick = () => {
                selectedDecade = null;
                updateDecadeButtons();
                updateBothMaps();
            };
            buttonsContainer.appendChild(allBtn);

            sortedDecades.forEach(decade => {
                const btn = document.createElement('button');
                btn.className = 'decade-btn';
                btn.textContent = `${decade}s`;
                btn.dataset.decade = decade;
                btn.onclick = () => {
                    selectedDecade = decade;
                    updateDecadeButtons();
                    updateBothMaps();
                };
                buttonsContainer.appendChild(btn);
            });
        }

        function updateDecadeButtons() {
            const buttons = document.querySelectorAll('.decade-btn');
            buttons.forEach(btn => {
                if (!btn.dataset.decade) {
                    btn.classList.toggle('active', selectedDecade === null);
                } else {
                    const decade = parseInt(btn.dataset.decade);
                    btn.classList.toggle('active', selectedDecade === decade);
                }
            });
        }

        function updateBothMaps() {
            updateEarthMap();
            updateSolarSystemMap();
        }

        // ========== EARTH MAP ==========
        function updateEarthMap() {
            const filteredConnections = selectedDecade === null
                ? earthConnections
                : earthConnections.filter(conn => getDecade(conn.year) === selectedDecade);

            document.getElementById('earthConnectionCount').textContent = filteredConnections.length;

            const usedCities = new Set();
            filteredConnections.forEach(conn => {
                usedCities.add(conn.from);
                usedCities.add(conn.to);
            });

            document.getElementById('earthCityCount').textContent = usedCities.size;

            drawEarthConnections(filteredConnections);
            drawEarthCities(usedCities, filteredConnections);
        }

        let earthSvg, earthProjection, earthConnectionGroup, earthCityGroup;

        function drawEarthConnections(connections) {
            if (!earthConnectionGroup) return;
            earthConnectionGroup.selectAll('*').remove();

            connections.forEach((conn, index) => {
                const from = earthCoordinates[conn.from];
                const to = earthCoordinates[conn.to];

                if (!from || !to) return;

                const start = earthProjection([from.lon, from.lat]);
                const end = earthProjection([to.lon, to.lat]);

                const dx = end[0] - start[0];
                const dy = end[1] - start[1];
                const dr = Math.sqrt(dx * dx + dy * dy) * 1.5;

                earthConnectionGroup.append('path')
                    .attr('class', 'connection earth')
                    .attr('data-movie', conn.movie)
                    .attr('d', `M${start[0]},${start[1]}A${dr},${dr} 0 0,1 ${end[0]},${end[1]}`)
                    .style('animation-delay', `${(index * 0.05) % 3}s`)
                    .on('mouseover', function(event) {
                        const currentMovie = d3.select(this).attr('data-movie');

                        earthConnectionGroup.selectAll('.connection').each(function() {
                            const path = d3.select(this);
                            if (path.attr('data-movie') === currentMovie) {
                                path.classed('highlighted', true);
                            }
                        });

                        tooltip.transition().duration(200).style('opacity', 0.95);
                        tooltip.html(`
                            <strong>${conn.movie}</strong> (${conn.year})<br/>
                            Filmed in: ${conn.from}<br/>
                            Takes place in: ${conn.to}
                        `)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        earthConnectionGroup.selectAll('.connection').classed('highlighted', false);
                        tooltip.transition().duration(500).style('opacity', 0);
                    });
            });
        }

        function drawEarthCities(usedCities, filteredConnections) {
            if (!earthCityGroup) return;
            earthCityGroup.selectAll('*').remove();

            const filmingLocations = new Set();
            filteredConnections.forEach(conn => {
                filmingLocations.add(conn.from);
            });

            Object.entries(earthCoordinates).forEach(([city, coords]) => {
                if (!usedCities.has(city)) return;

                const pos = earthProjection([coords.lon, coords.lat]);
                const isFilmingLocation = filmingLocations.has(city);

                earthCityGroup.append('circle')
                    .attr('class', isFilmingLocation ? 'city filming-location' : 'city')
                    .attr('cx', pos[0])
                    .attr('cy', pos[1])
                    .attr('r', 3)
                    .on('mouseover', function(event) {
                        d3.select(this).attr('r', 5);
                        tooltip.transition().duration(200).style('opacity', 0.95);
                        tooltip.html(`<strong>${city}</strong>`)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('r', 3);
                        tooltip.transition().duration(500).style('opacity', 0);
                    });
            });
        }

        async function initEarthMap() {
            try {
                const response = await fetch('./movie-coordinates.json');
                const coordinatesData = await response.json();

                earthCoordinates = coordinatesData.coordinates;
                earthConnections = coordinatesData.connections;

                const width = document.getElementById('earth-map').clientWidth;
                const height = 500;

                earthSvg = d3.select('#earth-map')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                earthProjection = d3.geoMercator()
                    .scale(100)
                    .translate([width / 2, height / 2]);

                const path = d3.geoPath().projection(earthProjection);

                const worldData = await d3.json('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson');

                earthSvg.append('g')
                    .selectAll('path')
                    .data(worldData.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('fill', '#d1d5db')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 0.5);

                earthConnectionGroup = earthSvg.append('g').attr('class', 'connections');
                earthCityGroup = earthSvg.append('g').attr('class', 'cities');

                updateEarthMap();

            } catch (error) {
                console.error('Error loading Earth map:', error);
                document.getElementById('earth-map').innerHTML =
                    `<div style="color: #ef4444; padding: 50px; text-align: center;">Error loading map data</div>`;
            }
        }

        // ========== SOLAR SYSTEM MAP ==========
        function updateSolarSystemMap() {
            const filteredConnections = selectedDecade === null
                ? spaceConnections
                : spaceConnections.filter(c => getDecade(c.year) === selectedDecade);

            document.getElementById('spaceConnectionCount').textContent = filteredConnections.length;

            const uniqueLocations = new Set();
            filteredConnections.forEach(c => {
                uniqueLocations.add(c.from);
                uniqueLocations.add(c.to);
            });
            document.getElementById('spaceLocationCount').textContent = uniqueLocations.size;

            drawSolarSystem(filteredConnections);
        }

        function drawSolarSystem(connections) {
            const container = document.getElementById('solar-system');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = 700;
            // Shift center to the right to avoid callout box
            const centerX = width * 0.65;
            const centerY = height / 2;

            const svg = d3.select('#solar-system')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Add stars
            for (let i = 0; i < 100; i++) {
                svg.append('circle')
                    .attr('cx', Math.random() * width)
                    .attr('cy', Math.random() * height)
                    .attr('r', Math.random() * 1.5)
                    .attr('fill', 'white')
                    .attr('opacity', Math.random() * 0.7 + 0.3);
            }

            const positions = {
                'Sun': { x: centerX, y: centerY, r: 18, color: '#ffa500', stroke: '#ffcc66' },
                'Earth': { x: centerX - 85, y: centerY + 30, r: 8, color: '#4a90e2', stroke: '#64c8ff' },
                'Moon': { x: centerX - 68, y: centerY + 40, r: 3, color: '#888', stroke: '#aaa' },
                'Mars': { x: centerX - 110, y: centerY - 20, r: 6, color: '#cd5c5c', stroke: '#ff6b6b' },
                'Jupiter': { x: centerX + 150, y: centerY - 50, r: 14, color: '#daa520', stroke: '#f4c542' },
                'Europa': { x: centerX + 168, y: centerY - 36, r: 3, color: '#c9d4e0', stroke: '#dde8f0' },
                'Deep Space': { x: width - 100, y: 70, r: 7, color: '#6a5acd', stroke: '#8a7ae0' },
                // Fictional planets
                'Arrakis': { x: width - 90, y: centerY + 100, r: 8, color: '#d946ef', stroke: '#e879f9' },
                // Fantasy locations (positioned to avoid callout box)
                'Dream Worlds': { x: width - 120, y: 150, r: 7, color: '#d946ef', stroke: '#e879f9' },
                'Virtual Reality': { x: width - 110, y: height - 80, r: 7, color: '#a855f7', stroke: '#c084fc' },
                'Alternate Reality': { x: centerX + 50, y: height - 70, r: 7, color: '#ec4899', stroke: '#f472b6' }
            };

            const connectionGroup = svg.append('g').attr('class', 'connections');
            const celestialGroup = svg.append('g').attr('class', 'celestial-bodies');

            // Draw orbit paths
            const orbitBodies = ['Earth', 'Mars', 'Jupiter'];
            orbitBodies.forEach(bodyName => {
                const body = positions[bodyName];
                const dist = Math.sqrt(Math.pow(body.x - centerX, 2) + Math.pow(body.y - centerY, 2));
                svg.append('circle')
                    .attr('class', 'orbit-path')
                    .attr('cx', centerX)
                    .attr('cy', centerY)
                    .attr('r', dist)
                    .lower();
            });

            // Draw connections
            connections.forEach((conn, index) => {
                const from = positions[conn.from];
                const to = positions[conn.to];

                if (!from || !to) return;

                const start = [from.x, from.y];
                const end = [to.x, to.y];

                const dx = end[0] - start[0];
                const dy = end[1] - start[1];
                const dr = Math.sqrt(dx * dx + dy * dy) * 1.3;

                // Determine if this is a fantasy or space connection
                const fantasyLocations = ['Dream Worlds', 'Virtual Reality', 'Alternate Reality', 'Arrakis'];
                const isFantasy = fantasyLocations.includes(conn.to);
                const connectionClass = isFantasy ? 'connection fantasy' : 'connection space';

                connectionGroup.append('path')
                    .attr('class', connectionClass)
                    .attr('data-movie', conn.movie)
                    .attr('d', `M${start[0]},${start[1]}A${dr},${dr} 0 0,1 ${end[0]},${end[1]}`)
                    .style('animation-delay', `${(index * 0.05) % 3}s`)
                    .on('mouseover', function(event) {
                        const currentMovie = d3.select(this).attr('data-movie');

                        connectionGroup.selectAll('.connection').each(function() {
                            const path = d3.select(this);
                            if (path.attr('data-movie') === currentMovie) {
                                path.classed('highlighted', true);
                            }
                        });

                        tooltip.transition().duration(200).style('opacity', 0.95);
                        tooltip.html(`
                            <strong>${conn.movie}</strong> (${conn.year})<br/>
                            Rating: ‚≠ê ${conn.rating}<br/>
                            Journey: ${conn.from} ‚Üí ${conn.to}
                        `)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        connectionGroup.selectAll('.connection').classed('highlighted', false);
                        tooltip.transition().duration(500).style('opacity', 0);
                    });
            });

            // Draw celestial bodies
            Object.entries(positions).forEach(([name, body]) => {
                const isSun = name === 'Sun';
                const isMoon = name === 'Moon' || name === 'Europa';

                celestialGroup.append('circle')
                    .attr('class', isSun ? 'sun' : (isMoon ? 'moon' : 'planet'))
                    .attr('cx', body.x)
                    .attr('cy', body.y)
                    .attr('r', body.r)
                    .attr('fill', body.color)
                    .attr('stroke', body.stroke)
                    .attr('stroke-width', isMoon ? 1 : 2)
                    .on('mouseover', function(event) {
                        if (!isSun) {
                            d3.select(this).attr('r', body.r * 1.3);
                        }

                        tooltip.transition().duration(200).style('opacity', 0.95);
                        tooltip.html(`<strong>${name}</strong>`)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function() {
                        if (!isSun) {
                            d3.select(this).attr('r', body.r);
                        }
                        tooltip.transition().duration(500).style('opacity', 0);
                    });

                // Customize label positions to avoid overlaps
                let labelX = body.x;
                let labelY = body.y + body.r + 12;

                if (name === 'Earth') {
                    labelX = body.x - 20; // Move Earth label left
                    labelY = body.y + body.r + 20; // Move Earth label down
                } else if (name === 'Moon') {
                    labelX = body.x + 15; // Shift Moon label to the right
                    labelY = body.y - body.r - 5; // Move Moon label above
                } else if (name === 'Mars') {
                    labelY = body.y - body.r - 6; // Put Mars label above the planet
                } else if (name === 'Jupiter') {
                    labelX = body.x - 25; // Move Jupiter label left
                    labelY = body.y + body.r + 20;
                } else if (name === 'Europa') {
                    labelX = body.x + 20; // Shift Europa label to the right
                    labelY = body.y - 8; // Position Europa label higher
                } else if (name === 'Arrakis') {
                    labelY = body.y + body.r + 18; // Below
                } else if (name === 'Dream Worlds') {
                    labelY = body.y + body.r + 18; // Below
                } else if (name === 'Virtual Reality') {
                    labelY = body.y - body.r - 6; // Above
                } else if (name === 'Alternate Reality') {
                    labelY = body.y + body.r + 18; // Below
                }

                celestialGroup.append('text')
                    .attr('class', 'planet-label')
                    .attr('x', labelX)
                    .attr('y', labelY)
                    .text(name);

                // Store Earth position for connector
                if (name === 'Earth') {
                    drawConnectorLines(body.x, body.y, body.r);
                }
            });
        }

        function drawConnectorLines(earthX, earthY, earthR) {
            // Get the callout box and connector SVG
            const calloutBox = document.querySelector('.callout-box');
            const connectorSvg = d3.select('#connector-svg');
            const mapsContainer = document.querySelector('.maps-container');

            // Get bounding rectangles
            const calloutRect = calloutBox.getBoundingClientRect();
            const containerRect = mapsContainer.getBoundingClientRect();

            // Earth's position is already in SVG coordinates
            // The solar system section has a header, so we need to account for that
            const solarSystemHeaderHeight = 60; // Approximate height of h2 + padding

            // Adjust position to better align with visual Earth position
            const earthAbsX = earthX + 20; // Move right
            const earthAbsY = earthY + solarSystemHeaderHeight + 37; // Move down

            // Callout box position relative to container
            const calloutRight = calloutRect.width + 20;
            const calloutMidY = calloutRect.height / 2 + 20; // 20 is top offset

            // Clear existing connectors
            connectorSvg.selectAll('*').remove();

            // Draw connector lines from Earth to callout box
            const lineGroup = connectorSvg.append('g');

            // Main connector line from Earth to callout box
            lineGroup.append('line')
                .attr('x1', earthAbsX)
                .attr('y1', earthAbsY)
                .attr('x2', calloutRight)
                .attr('y2', calloutMidY)
                .attr('stroke', 'rgba(100, 200, 255, 0.6)')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '5, 5');

            // Add a pulsing circle around Earth
            lineGroup.append('circle')
                .attr('cx', earthAbsX)
                .attr('cy', earthAbsY)
                .attr('r', earthR + 4)
                .attr('fill', 'none')
                .attr('stroke', 'rgba(100, 200, 255, 0.8)')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', '3, 3')
                .style('animation', 'pulse 2s ease-in-out infinite');

            // Arrow pointing to callout box
            lineGroup.append('polygon')
                .attr('points', `${calloutRight},${calloutMidY} ${calloutRight + 8},${calloutMidY - 6} ${calloutRight + 8},${calloutMidY + 6}`)
                .attr('fill', 'rgba(100, 200, 255, 0.6)');
        }

        // Initialize
        async function init() {
            // Create shared tooltip
            tooltip = d3.select('body')
                .append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);

            await initEarthMap();
            createDecadeButtons();
            updateSolarSystemMap();

            // Make callout box clickable
            const calloutBox = document.querySelector('.callout-box');
            if (calloutBox) {
                calloutBox.addEventListener('click', () => {
                    window.location.href = './connection-map.html';
                });
            }
        }

        init();
    </script>
</body>
</html>
